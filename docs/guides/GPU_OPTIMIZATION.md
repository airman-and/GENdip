# GPU 최적화 가이드

## 현재 GPU 설정

- **GPU 개수**: 2개
- **GPU 모델**: Quadro RTX 8000
- **GPU 메모리**: 각 50.75 GB

## 자동 최적화 기능

`train_stylegan.py`는 GPU를 최대한 활용하도록 자동 최적화됩니다:

### 1. GPU 개수 자동 감지
- 사용 가능한 모든 GPU 자동 감지
- StyleGAN 제약: GPU 개수는 2의 거듭제곱만 가능 (1, 2, 4, 8...)
- 현재 2개 GPU → 2개 모두 사용

### 2. 배치 크기 자동 계산
- GPU 메모리에 따라 최적 배치 크기 자동 계산
- **50GB 메모리 기준**:
  - 128x128 이미지: 배치 크기 ~128 (단일 GPU 기준)
  - 2개 GPU 사용 시: 배치 크기 ~256

### 3. DataLoader Workers 최적화
- CPU 코어 수에 따라 자동 조정
- 최대 8개 workers 사용

### 4. TF32 활성화
- RTX 30/40 시리즈 및 A100에서 성능 향상
- 자동으로 활성화됨

### 5. Mixed Precision
- 기본적으로 활성화됨 (FP16)
- 메모리 사용량 감소 및 학습 속도 향상

## 수동 설정

자동 최적화를 원하지 않으면 수동으로 설정 가능:

```python
train_stylegan(
    num_epochs=30,
    batch_size=128,  # 수동 설정
    image_size=128,
    auto_optimize=False  # 자동 최적화 비활성화
)
```

## 예상 성능

### 배치 크기별 메모리 사용량 (128x128 이미지)

| 배치 크기 | 단일 GPU 메모리 | 2 GPU 총 메모리 |
|-----------|----------------|-----------------|
| 32        | ~8 GB          | ~16 GB          |
| 64        | ~16 GB         | ~32 GB          |
| 128       | ~32 GB         | ~64 GB          |
| 256       | ~64 GB         | ~128 GB (초과)  |

**권장**: 배치 크기 128 (2 GPU 사용 시 총 256)

### 학습 속도

- **단일 GPU (배치 32)**: ~1-2 이미지/초
- **2 GPU (배치 128)**: ~3-4 이미지/초
- **최적화된 설정**: ~4-6 이미지/초

## 최적화 팁

1. **배치 크기 최대화**
   - GPU 메모리가 충분하면 배치 크기를 크게 설정
   - 50GB 메모리면 배치 128까지 가능

2. **Workers 수 조정**
   - CPU가 많으면 workers 수 증가
   - 너무 많으면 오히려 느려질 수 있음 (최대 8개 권장)

3. **Mixed Precision 유지**
   - FP16 사용으로 메모리 절약 및 속도 향상
   - 품질 저하 없음

4. **TF32 활용**
   - RTX 8000은 TF32 지원
   - 자동으로 활성화됨

## 모니터링

학습 중 GPU 사용량 확인:

```bash
# 다른 터미널에서
watch -n 1 nvidia-smi
```

또는:

```bash
nvidia-smi -l 1
```

## 문제 해결

### Out of Memory (OOM) 에러
- 배치 크기 줄이기
- `batch_size` 파라미터로 수동 조정

### GPU 사용률 낮음
- Workers 수 증가
- 배치 크기 증가
- 데이터 로딩 병목 확인

### 학습 속도 느림
- Mixed precision 확인 (기본 활성화)
- TF32 확인 (자동 활성화)
- 배치 크기 최적화

